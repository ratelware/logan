CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
PROJECT (MasterProject)

SET(ROOT_DIR ${CMAKE_SOURCE_DIR})
SET_PROPERTY(GLOBAL PROPERTY USE_FOLDERS ON)

INCLUDE(${ROOT_DIR}/buildsystem/compiler_support.cmake)
INCLUDE(${ROOT_DIR}/buildsystem/library_support.cmake)
INCLUDE(${ROOT_DIR}/buildsystem/utilities.cmake)

SET(CMAKE_BINARY_DIR ${CMAKE_SOURCE_DIR}/bin)
SET(CMAKE_LIBRARY_OUTPUT_DIRECTORY  ${CMAKE_BINARY_DIR}/lib)
SET(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/exe)

MESSAGE(STATUS "Using library output directory: ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}")
MESSAGE(STATUS "Using runtime output directory: ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}")

SET_WARNING_LEVEL()
DISABLE_COMPILER_EXTENSIONS()
IF (CMAKE_CXX_COMPILER_ID STREQUAL "GNU" OR CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
    ADD_SANITIZERS_TO_BUILD()
    SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++1y -pthread")

    IF(CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
        SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -stdlib=libc++")
    ENDIF(CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
ENDIF(CMAKE_CXX_COMPILER_ID STREQUAL "GNU" OR CMAKE_CXX_COMPILER_ID STREQUAL "Clang")

IF (MSVC)
    ENABLE_MULTIPROCESSOR_BUILD()
ENDIF (MSVC)

MESSAGE(STATUS "Using C++ compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")

#External dependencies
FIND_PACKAGE(Threads REQUIRED)
ADD_DEPENDENCY_TO_BOOST("1.55.0")
ADD_DEPENDENCY_TO_OPEN_CV()

SET(EXTERNAL_LIBRARIES ${OpenCV_LIBS} ${Boost_LIBRARIES} ${CMAKE_THREAD_LIBS_INIT})

INCLUDE_DIRECTORIES(${Boost_INCLUDE_DIRS})

ADD_SUBDIRECTORY(production)
SET(TARGETS ${INTERNAL_LIBRARIES})

IF (${PRODUCTION_INCLUDE_DIR} STREQUAL "")
    MESSAGE(FATAL_ERROR "PRODUCTION_INCLUDE_DIR shall be set by cmake files in production code")
ENDIF(${PRODUCTION_INCLUDE_DIR} STREQUAL "")

INCLUDE_DIRECTORIES(${PRODUCTION_INCLUDE_DIR})
INCLUDE_DIRECTORIES(${LIBRARY_INCLUDE_DIRS})

OPTION(WITH_EXECUTABLE "Compile executable version of the project" ON)
OPTION(WITH_TESTCASES "Compile test suite for the project" ON)
OPTION(WITH_BENCHMARKS "Compile benchmarks for the project" ON)

IF(${WITH_TESTCASES} OR ${WITH_BENCHMARKS})
    ADD_SUBDIRECTORY(tests)
	
	IF(${WITH_TESTCASES})
        SET(TARGETS ${TARGETS} ${TESTCASES_PROJECT})
	ENDIF(${WITH_TESTCASES})
	
	IF(${WITH_BENCHMARKS})
        SET(TARGETS ${TARGETS} ${BENCHMARK_PROJECT})
	ENDIF(${WITH_BENCHMARKS})
ENDIF(${WITH_TESTCASES} OR ${WITH_BENCHMARKS})

IF(${WITH_EXECUTABLE})
    ADD_SUBDIRECTORY(executable)
    ADD_DEPENDENCIES(${EXECUTABLE_PROJECT} ${INTERNAL_LIBRARIES} ${SEMI_INTERNAL_LIBRARIES})
	SET(TARGETS ${TARGETS} ${EXECUTABLE_PROJECT})
ENDIF(${WITH_EXECUTABLE})

SET_OUTPUT_DIRECTORIES(${TARGETS})